以下是 **DERP 服务器租赁与管理系统** 的 **完整需求分析**：

---

## **DERP 服务器租赁与管理系统 需求分析**

### **1. 用户管理模块**

#### **1.1 用户管理功能**
- **用户注册与登录**：支持用户通过邮箱注册，进行邮箱验证后注册成功；用户可以登录查看租赁信息、序列号绑定和租赁到期时间；支持管理员角色区分。
- **续费管理**：用户租赁到期后，管理员可帮助用户续费，并指定续费结束日期，系统会更新用户的租赁到期时间并发送续费成功通知邮件。
- **用户到期处理**：到期后自动释放服务器资源，并保留已注销用户的使用记录，提供历史记录查询。

#### **1.2 数据需求**
- **用户表**：包含用户名、邮箱、密码、角色、租赁到期时间等。
- **租赁表**：记录每个用户的租赁状态（已过期、有效等）。

#### **1.3 接口需求**
- **用户注册与登录接口**
- **续费管理接口**：管理员可以帮助用户续费。
- **续费通知接口**：在用户到期前7天、3天、1天发送提醒。

---

### **2. 序列号管理模块**

#### **2.1 序列号管理功能**
- **序列号生成与管理**：管理员生成序列号，设置有效期（天数）和状态（未使用、已使用、过期）。用户激活序列号后，绑定到租赁服务。
- **序列号过期管理**：明确记录每个序列号的过期时间，当到期后自动更新状态为 `expired`。
- **序列号与用户租赁时间关联**：用户绑定序列号时，系统根据序列号的有效期调整用户的租赁到期时间。续费时，续费的有效期将累加到当前租赁时间，而不是覆盖原有的到期时间。

#### **2.2 数据需求**
- **序列号表**：包括序列号代码、有效天数、状态、绑定的用户 ID、创建时间、使用时间、过期时间等字段。

#### **2.3 接口需求**
- **序列号生成接口**
- **序列号激活接口**：用户激活序列号。
- **序列号状态查询接口**：查询某个序列号的使用状态。

---

### **3. 服务器管理模块**

#### **3.1 服务器管理功能**
- **服务器信息管理**：管理员查看服务器的基本信息，如 IP 地址、地区、负载、流量等，并支持新增、删除、更新服务器信息。
- **服务器资源管理**：管理员可以查看服务器的流量使用情况，支持服务器流量限制，超流量时自动关闭容器。
- **服务器健康监控**：管理员查看服务器健康状态，并接收负载、流量等的实时监控数据。

#### **3.2 数据需求**
- **服务器表**：包括 IP 地址、地区、负载、流量、状态、硬件配置等字段。

#### **3.3 接口需求**
- **服务器信息管理接口**
- **服务器健康监控接口**
- **流量管理接口**：查看服务器流量、限制流量等。

---

### **4. 容器管理模块**

#### **4.1 容器管理功能**
- **容器分配与管理**：每个用户分配独立的 Docker 容器，容器需绑定到用户和服务器，支持动态端口分配。
- **容器流量统计**：按容器记录用户流量，包括上传流量和下载流量，且可设置流量上限。

#### **4.2 数据需求**
- **用户容器表**：包括容器 ID、用户 ID、服务器 ID、端口、流量统计等字段。

#### **4.3 接口需求**
- **容器分配接口**
- **容器流量统计接口**

---

### **5. ACL 管理模块**

#### **5.1 ACL 配置管理**
- **ACL 配置生成与管理**：管理员为每个用户生成 ACL 配置，配置用户访问服务器的权限。支持手动和自动更新 ACL 配置。

#### **5.2 数据需求**
- **ACL 配置表**：包括用户 ID、绑定服务器、权限、版本号等字段。

#### **5.3 接口需求**
- **ACL 配置生成接口**
- **ACL 校验接口**：在用户请求时校验 ACL 权限。

---

### **6. 监控与告警模块**

#### **6.1 监控功能**
- **服务器监控**：系统实时监控服务器的 CPU 使用率、内存、流量、负载等。
- **告警机制**：当监控指标超过预设阈值时，自动触发告警并发送通知。

#### **6.2 数据需求**
- **监控日志表**：记录每个服务器的监控指标和对应的值。
- **告警表**：包括告警类型、严重性、告警信息、是否解决等字段。

#### **6.3 接口需求**
- **监控日志接口**
- **告警发送接口**：触发并发送告警。

---

### **7. 财务管理模块**

#### **7.1 套餐管理功能**
- **套餐管理**：管理员设置不同租赁套餐（如 3 天、5 天、30 天等），并生成对应的序列号。
- **财务统计**：系统自动统计收益、套餐销售数量、用户支付等信息。

#### **7.2 数据需求**
- **财务表**：记录收入、套餐销售数量、用户支付情况等信息。

#### **7.3 接口需求**
- **财务统计接口**
- **财务报表接口**

---

### **8. 高可用模块**

#### **8.1 故障切换功能**
- **故障切换**：系统支持故障自动切换，确保服务不中断。

#### **8.2 接口需求**
- **故障切换接口**：用于处理系统出现故障时的切换操作。

---

### **9. 流量管理模块**

#### **9.1 流量监控功能**
- **流量监控**：实时监控每个服务器和容器的流量使用情况。
- **流量限制**：支持根据套餐和用户配置限制每个容器的最大流量。

#### **9.2 数据需求**
- **流量表**：记录每个用户容器的上传和下载流量。

#### **9.3 接口需求**
- **实时流量接口**
- **流量统计接口**
- **超流量检测接口**

---

### **10. 安全与设备绑定模块**

#### **10.1 设备绑定管理**
- **设备绑定与解绑**：用户通过 **序列号激活后，绑定的服务器资源** 与用户的 **序列号、容器以及 ACL 配置挂钩**，而不是设备本身的绑定。
- **设备验证**：通过 **序列号与服务器资源的绑定** 进行验证。

#### **10.2 数据需求**
- **设备绑定表**：数据结构侧重于记录 **用户与服务器资源、序列号的绑定关系**，每个序列号的激活与服务器资源、容器的管理挂钩。

#### **10.3 接口需求**
- **序列号核销接口**：用户在购买序列号后进行激活，并与 **服务器资源**（包括容器和 ACL 配置）关联。
- **续费管理接口**：用户通过购买新序列号或续费序列号来延长 **服务器资源的使用时间**。
- **自动资源释放接口**：当用户未续费时，自动注销对应的 Docker 容器和服务器资源。

---

### **11. 分销管理模块**

#### **11.1 分销员分销模式**
- **分销员的两种分销模式**：
  1. **第一种模式**：用户通过分销员的独特链接注册并购买序列号，分销员通过该模式获得佣金。
  2. **第二种模式**：分销员直接购买序列号并卖给客户，赚取差价。

#### **11.2 分销员佣金核算**
- **佣金核算**：通过 **第一种模式** 的分销序列号销售额来核算分销员的佣金收入。
- 通过 **月度计划** 进行统计，按月核算分销员的 **佣金总额**。
- 分销员也可以根据自己的购买序列号的数量和销售价格获得相应的分销利润。

---

### **12. 服务器监控与负载管理**

#### **12.1 Docker 容器健康状态表 (`docker_health_status`)**
- 用于记录每个 **Docker 容器** 的健康状况，包括 **DERP 服务的健康状态** 和 **其他监控指标**（如容器负载等）。

#### **12.2 服务器负载监控表 (`server

_load_status`)**
- 用于记录每台服务器的负载情况，包括当前运行的 Docker 容器数量、CPU 使用率、内存使用情况等。

---

### **总结**
- **需求完善**：涵盖了用户管理、序列号管理、服务器管理、容器管理、ACL 配置、监控与告警、财务管理、高可用等模块，已全面覆盖系统的核心功能。
- **序列号与用户时间管理**：确保了用户的租赁到期时间与 **序列号绑定** 和 **续费管理** 的关系紧密结合。
- **模块功能**：每个模块的功能需求、数据需求和接口需求都已明确，接下来可以进行逐步的代码开发和测试。

---

### **接下来的步骤**
1. **补充数据库设计**：根据更新后的需求，进一步完善数据库表结构，确保字段和关系合理。
2. **完善 API 接口**：根据接口需求开发相应的 API 路由，确保每个模块功能正常。
3. **测试与调试**：逐步实现各个功能模块，并进行功能测试，确保数据流和功能逻辑正确。

---

如果您有任何问题或需要进一步帮助，请随时告诉我！
### **数据库表设计**

根据系统需求，以下是数据库表结构的初步设计：

| 表名                 | 字段                                   | 类型             | 描述                                                     |
|----------------------|---------------------------------------|------------------|----------------------------------------------------------|
| `users`              | `id`                                 | Integer (PK)     | 用户 ID                                                  |
|                      | `username`                           | String (unique)  | 用户名                                                   |
|                      | `email`                              | String (unique)  | 邮箱地址                                                 |
|                      | `password`                           | String           | 密码                                                     |
|                      | `role`                               | String           | 用户角色（如 `user`, `admin`）                           |
|                      | `rental_expiry`                      | DateTime         | 租赁到期时间                                             |
|                      | `created_at`                         | DateTime         | 用户创建时间                                             |
| `serial_numbers`     | `id`                                 | Integer (PK)     | 序列号 ID                                                |
|                      | `code`                               | String (unique)  | 序列号代码                                               |
|                      | `duration_days`                      | Integer          | 有效天数                                                 |
|                      | `status`                             | String           | 序列号状态（`unused`, `used`, `expired`）                |
|                      | `user_id`                            | Integer (FK)     | 用户 ID（外键）                                          |
|                      | `created_at`                         | DateTime         | 序列号创建时间                                           |
|                      | `used_at`                            | DateTime         | 序列号使用时间                                           |
| `servers`            | `id`                                 | Integer (PK)     | 服务器 ID                                                |
|                      | `ip`                                 | String           | IP 地址                                                  |
|                      | `region`                             | String           | 服务器所在地区                                           |
|                      | `load`                               | Float            | 当前负载                                                 |
|                      | `status`                             | String           | 服务器状态（`healthy`, `unhealthy`）                     |
|                      | `created_at`                         | DateTime         | 创建时间                                                 |
|                      | `updated_at`                         | DateTime         | 更新时间                                                 |
| `acl_logs`           | `id`                                 | Integer (PK)     | 日志 ID                                                  |
|                      | `user_id`                            | Integer (FK)     | 用户 ID（外键）                                          |
|                      | `ip_address`                         | String           | 用户 IP 地址                                             |
|                      | `location`                           | String           | 地理位置                                                 |
|                      | `acl_version`                        | String           | ACL 版本号                                               |
|                      | `created_at`                         | DateTime         | 创建时间                                                 |
| `monitoring_logs`    | `id`                                 | Integer (PK)     | 日志 ID                                                  |
|                      | `server_id`                          | Integer (FK)     | 服务器 ID（外键）                                        |
|                      | `metric`                             | String           | 监控指标                                                 |
|                      | `value`                              | Float            | 监控值                                                   |
|                      | `timestamp`                          | DateTime         | 时间戳                                                   |
| `system_alerts`      | `id`                                 | Integer (PK)     | 告警 ID                                                  |
|                      | `alert_type`                         | String           | 告警类型                                                 |
|                      | `severity`                           | String           | 严重程度（`info`, `warning`, `critical`）                |
|                      | `message`                            | String           | 告警信息                                                 |
|                      | `resolved`                           | Boolean          | 是否已解决                                               |

---

### **API 接口设计**

以下是主要 API 的设计概要：

| 模块                  | 路由                                     | 方法   | 描述                                   | 请求参数                                   | 返回值示例                                      |
|-----------------------|------------------------------------------|--------|----------------------------------------|-------------------------------------------|-----------------------------------------------|
| 用户模块              | `/api/user/register`                    | POST   | 用户注册                               | `{ "username": "test", "email": "...", ...}` | `{ "success": true, "user_id": 1 }`           |
|                       | `/api/user/login`                       | POST   | 用户登录                               | `{ "email": "...", "password": "..." }`    | `{ "success": true, "token": "..." }`         |
| 序列号管理模块        | `/api/serial/generate`                  |

 POST   | 管理员生成序列号                       | `{ "duration_days": 30 }`                  | `{ "success": true, "serial_numbers": ["..."] }` |
| 服务器管理模块        | `/api/server/add`                       | POST   | 添加服务器                             | `{ "ip": "...", "region": "..." }`         | `{ "success": true, "server_id": 1 }`         |
| 容器管理模块          | `/api/container/allocate`               | POST   | 分配容器                               | `{ "user_id": 1, "server_id": 1, ... }`    | `{ "success": true, "container_id": 1 }`      |
| ACL 管理模块          | `/api/acl/generate`                     | POST   | 生成 ACL 配置                          | `{ "user_id": 1, "server_ids": [1, 2] }`   | `{ "success": true, "acl": { ... } }`         |
| 高可用模块            | `/api/ha/failover`                      | POST   | 故障切换                               | 无                                         | `{ "success": true, "message": "..." }`       |
| 日志管理模块          | `/api/logs/system`                      | GET    | 查询系统日志                           | 无                                         | `{ "success": true, "logs": [ ... ] }`        |
| 财务模块              | `/api/finance/statistics`               | GET    | 获取财务统计数据                       | 无                                         | `{ "success": true, "total_revenue": 1000 }`  |
| 监控模块              | `/api/monitoring/load_analysis`         | GET    | 分析服务器负载                         | 无                                         | `{ "success": true, "load_analysis": [...] }` |
| 通知模块              | `/api/notifications/send`               | POST   | 发送通知                               | `{ "user_id": 1, "subject": "...", ... }`  | `{ "success": true, "message": "Sent" }`      |

---

#
