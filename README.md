mysql数据存储


以下是 **DERP 服务器租赁与管理系统** 的完整需求汇总：

---

### **1. 用户管理**

- **注册与登录**：
  - 用户通过邮箱注册，支持邮箱验证。
  - 用户可通过序列号绑定租赁套餐，生成 ACL 配置和服务器权限。
  - 用户登录分为管理员和普通用户登录，权限不同。
  
- **用户界面**：
  - 查看当前租赁信息：租赁时长、到期时间、剩余流量。
  - 支持主动续费：根据套餐延长租赁时间。
  - 提供 ACL 配置下载，绑定三台 DERP 服务器。
  
- **用户到期处理**：
  - 到期后自动释放服务器资源。
  - 提供用户历史记录查询，保留已注销用户的使用记录。
  
- **序列号激活**：
  - 用户可输入管理员生成的序列号激活租赁服务。
  - 每个序列号绑定一个用户，仅可使用一次。

- **用户注销功能**：
  - 注销前销毁 ACL 文件、包含的服务器对应 Docker 容器（通过 SSH 登录释放）。
  - 检查用户财务结算是否完整（包括续费）。
  - 到期未续费或管理员操作不续费时，保留用户权限，但关停其 DERP 服务。
  - 超过 30 天未续费的用户将自动注销。
  - 用户注册时，邮箱每隔 10 分钟只能发送 5 封邮件。

---

### **2. ACL 管理**

- **ACL 生成**：
  - 动态生成用户 ACL 配置，包含三台服务器（高可用）。
  - 配置绑定用户注册设备，限制使用范围。
  
- **ACL 更新**：
  - 设置 32 天自动失效机制，到期时重新生成 ACL。
  - 支持管理员手动更新 ACL 配置。
  
- **ACL 日志记录**：
  - 每次生成 ACL 时记录用户 IP 地址、地理位置、生成时间和配置版本。
  - 管理员可查询 ACL 生成历史日志。
  
- **ACL 校验**：
  - 下载 ACL 文件需校验序列号是否已付费（已使用序列号）。
  - 不同用户之间无法查看 ACL 配置文件。
  - 下载时记录用户名、IP、机器校验码、浏览器信息等数据，允许管理员、超级管理员和分销账号查看 ACL 文件下载情况。

---

### **3. 服务器管理**

- **服务器列表**：
  - 显示服务器的 IP 地址、地区、用户数、流量消耗、速率。
  - 按地区统计服务器的用户数和负载状态。

- **服务器资源管理**：
  - 支持自动关闭超流量的服务器 Docker 容器。
  - 提供健康检测与时延检测，记录历史趋势图。

- **服务器删除与用户通知**：
  - 管理员可删除异常或负载高的服务器，并通知相关用户更新 ACL。

- **服务器扩展信息**：
  - 每台服务器对应的阿里云账号（手机号）。
  - 显示 IP 所在国内地址、公网 IP 地址、用户数（DERP 服务器主要是 Docker 容器数量）、总体流量及月度剩余流量。

---

### **4. Docker 容器管理**

- **容器隔离**：
  - 每个用户分配独立 Docker 容器和端口，避免端口冲突。

- **容器生命周期管理**：
  - 到期后自动释放用户的容器。
  - 新续费时延长容器使用时间或重新分配。

- **流量统计**：
  - 按容器记录用户流量，包括实时速率和总流量。

---

### **5. 财务管理**

- **套餐定价与序列号管理**：
  - 管理员设置租赁套餐（3天、5天、30天、180天、360天）。
  - 自动生成复杂序列号，供用户激活租赁。

- **财务统计**：
  - 显示当月收益、历史总收益。
  - 统计用户预付款余额和套餐购买数量。

- **订单管理**：
  - 查看用户订单历史，支持完成、续费和取消状态标记。

- **分销系统财务管理**：
  - 管理员查看分销员账号的财务信息，包括分销员的分销金额。

---

### **6. 分销管理**

- **分销员类别**：
  - 分销员分为：黄金分销员（10%）、白金分销员（15%）、铂金分销员（20%）三类，按营业额比例分成。

- **序列号生成与分销**：
  - 分销员可以生成序列号，用以开辟服务器资源和权限。
  - 分销员申请生成序列号，管理员审核后发送。
  - 分销员购买序列号时，按分销员类别打折。

- **支付与结算**：
  - 分销员可以在网站上支付购买序列号，或等待超级管理员确认收款后发送。

---

### **7. 系统安全性**

- **设备绑定**：
  - ACL 配置仅允许用户注册设备访问。

- **流量异常监控**：
  - 检测用户流量异常情况（速率过高或超限）。

- **权限与日志**：
  - 管理员界面支持多级权限分配。
  - 提供系统操作日志，追踪管理员和用户的关键操作。

---

### **8. 收费模块**

- **支付方式**：
  - 提供支付宝和微信两大收款账号信息。

---

### **9. 续费功能**

- **管理员续费**：
  - 允许管理员帮助用户续费至指定日期。
  
- **续费通知**：
  - 预设 7 天、3 天和 1 天续费通知。
  
- **自动注销**：
  - 超过 30 天未续费的用户将自动注销。

---

### **10. 序列号管理**

- **序列号生成与过期**：
  - 新生成的序列号 30 天后自动过期。
  - 序列号管理板块：记录用户使用情况、状态查看、服务器关联匹配、与 Docker 容器的关联等。
  - 序列号与分销系统相融合，提升功能与管理效率。

---

### **11. 技术栈**

- **前端**：
  - React（用户与管理员界面，动态展示用户与服务器状态）。

- **数据库**：
  - MySQL（数据存储）。

- **后端**：
  - Flask 或 FastAPI（实现核心逻辑）。
  - 使用 Celery 和 Redis 处理异步任务（如容器释放、ACL 到期等）。

- **消息通知**：
  - 使用 SMTP 发送邮件通知（如续费提醒、ACL 更新）。

---

### **12. 部署与实施步骤**

1. **开发阶段**：
   - 开发核心功能：用户注册登录、序列号激活、ACL 配置生成与更新。
   - Docker 容器管理和服务器负载监控。
   - 财务统计和管理员操作界面。
   
2. **初始部署**：
   - 使用一台轻量云服务器部署系统，安装 Docker 和所需依赖。
   - 初始化 MySQL 数据库，创建表结构。

3. **生产部署**：
   - 引入负载均衡（如 Nginx）和 Redis 缓存提升性能。

4. **监控与报警**：
   - 部署 Prometheus 和 Grafana 配置流量和系统异常报警。

---

### **总结**

- 系统设计为模块化，确保各个功能独立、可扩展。
- 自动化与安全性得到高度重视，如自动续费、ACL 配置的严格权限控制、多因素认证等。
- 续费功能与日志系统、支付系统与分销系统高度整合，以提高管理效率与用户体验。

---

这是完整的 **DERP 服务器租赁与管理系统** 的需求分析，确保各模块和功能都包含在内。如有任何修改或进一步的调整，请随时告知！

### **阶段性总结**

#### **1. 当前代码与需求完成度对比**
经过对上传的最终需求文档和代码仓库的对比，以下是对需求完成情况的总结：

#### **已完成部分：**
1. **用户管理**
   - 注册与登录功能已完成，包括邮箱注册和邮箱验证码验证。
   - 用户租赁信息查询已实现，支持查询租赁时长、到期时间等。
   - 序列号激活功能已实现，用户可通过序列号绑定租赁套餐。
   - 用户历史记录持久化功能已实现，通过 `UserHistory` 模型记录用户租赁历史。

2. **ACL 管理**
   - 动态生成和更新用户 ACL 配置。
   - ACL 日志记录功能完成，记录 IP、地理位置、生成时间和配置版本。
   - 支持 ACL 配置下载，满足用户需求。

3. **服务器管理**
   - 服务器的增删改查功能实现。
   - 服务器的健康检查和负载状态监控已通过 `server_utils` 实现。
   - 按地区统计用户数和负载状态部分已实现。

4. **Docker 容器管理**
   - 容器的动态分配和生命周期管理已实现。
   - 到期后容器的释放功能通过 `tasks.py` 实现。
   - 支持按容器记录用户流量。

5. **财务管理**
   - 序列号生成和订单管理实现，支持不同套餐的序列号生成和用户订单查询。
   - 财务统计功能实现，显示总收益和历史收益。

6. **系统安全性**
   - 用户流量监控和日志记录已实现。
   - 提供 ACL 配置绑定用户注册设备功能。

#### **待完善部分：**
1. **用户界面**
   - 前端页面需要进一步完善，以支持用户查看 ACL 配置、租赁信息和历史记录。

2. **ACL 管理**
   - 尚未完全实现 ACL 配置绑定用户注册设备的逻辑。

3. **服务器管理**
   - 部分高级功能（如超流量的 Docker 容器自动关闭）未完成。
   - 时延检测和历史趋势图的功能尚未开发。

4. **系统高可用性**
   - 高可用架构的实现（如 Kubernetes 或 Docker Swarm）尚未部署。
   - Redis 缓存和负载均衡需要在生产环境进一步优化。

---

### **下一步计划**

#### **1. 前端开发**
- 根据后端的 API 接口完善前端页面：
  - 用户租赁信息、序列号激活、历史记录查询。
  - 管理员的服务器监控界面，包括健康状态和负载状态显示。
- 打包前端代码并部署到 Nginx 或其他静态服务器。

#### **2. 生产环境优化**
- 部署 Redis 缓存以优化性能。
- 使用 Nginx 配置负载均衡，提高系统高并发能力。
- 设置日志监控和告警功能，部署 Prometheus 和 Grafana。

#### **3. 自动化管理**
- 编写 Docker Compose 文件，统一管理后端、前端和数据库。
- 完善定时任务，确保到期容器的释放和 ACL 的自动更新。

#### **4. 测试与文档**
- 对现有功能进行全面测试，编写单元测试和集成测试。
- 整理项目的 API 文档，包括所有已实现的接口。

---

### **API 接口说明**

以下是系统的主要 API 列表：

#### **用户管理**
| 方法 | 路径                          | 描述                         |
|------|-------------------------------|------------------------------|
| POST | `/api/user/add_user`          | 用户注册                     |
| POST | `/api/user/login`             | 用户登录                     |
| GET  | `/api/user/rental_info`       | 获取租赁信息                 |
| GET  | `/api/user/history/<user_id>` | 获取用户历史记录             |

#### **ACL 管理**
| 方法 | 路径                          | 描述                         |
|------|-------------------------------|------------------------------|
| POST | `/api/acl/generate`           | 动态生成 ACL 配置            |
| POST | `/api/acl/update`             | 手动更新 ACL 配置            |
| GET  | `/api/acl/logs/<user_id>`     | 查询 ACL 日志记录            |
| GET  | `/api/acl/download/<username>`| 下载 ACL 配置文件            |

#### **服务器管理**
| 方法 | 路径                          | 描述                         |
|------|-------------------------------|------------------------------|
| POST | `/api/add_server`             | 添加服务器                   |
| GET  | `/api/server/status/<id>`     | 查询服务器状态               |
| GET  | `/api/server/health_check`    | 监控所有服务器健康           |

#### **容器管理**
| 方法 | 路径                          | 描述                         |
|------|-------------------------------|------------------------------|
| POST | `/api/container/allocate`     | 动态分配容器                 |
| GET  | `/api/container/status/<id>`  | 查询容器状态                 |
| DELETE | `/api/container/release/<id>`| 释放容器                     |
| GET  | `/api/container/list`         | 列出所有容器                 |

#### **财务管理**
| 方法 | 路径                          | 描述                         |
|------|-------------------------------|------------------------------|
| GET  | `/api/finance/statistics`     | 获取财务统计数据             |
| GET  | `/api/finance/orders/<id>`    | 获取用户订单记录             |
| POST | `/api/finance/generate_serial`| 管理员生成序列号             |

#### **日志管理**
| 方法 | 路径                          | 描述                         |
|------|-------------------------------|------------------------------|
| GET  | `/api/logs/system`            | 查询系统日志                 |

---

请确认下一步重点是**前端完善**还是**后端优化与部署**？如果需要更多功能细化，可以进一步分解目标！
