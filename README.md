### 需求梳理与分类
---

### **1. 用户管理模块**
#### 1.1 管理员角色与权限
角色与权限划分
1. 超级管理员
权限：超级管理员具备系统中所有权限，包括但不限于：
系统配置管理：能够设置和修改系统的全局配置，如支付方式、邮件模板、系统参数等。
权限管理：分配和管理普通管理员、分销管理员以及普通用户的权限。
分销系统管理：配置分销员的分成比例，管理分销员账户。
财务管理：查看财务数据，进行结算与调整。
所有操作权限：能够执行任何操作，包括查看和修改任何用户的数据。
2. 普通管理员
权限：普通管理员权限较为有限，主要集中在日常的管理任务上：
用户管理：查看普通用户的业务流程，如注册信息、序列号使用情况等。
日常管理：执行用户的更新、删除、维护等任务。
无法访问财务系统：不能查看或修改财务相关数据，无法修改系统配置、分销系统等内容。
3. 分销管理员
权限：分销管理员在超级管理员和普通管理员的权限控制下，主要负责与序列号和用户管理相关的功能：
生成序列号：负责生成带有时间长度的序列号，关联服务器资源和容器。
管理序列号：管理生成的序列号，包括序列号的使用、过期和状态更新等。
财务分成：分销管理员能够管理与自己生成的序列号相关的财务分成，查看分销收入。
分销员管理：可以管理分销员生成的序列号，以及这些序列号的用户注册情况和使用情况。
权限受限：分销管理员的权限仅限于与序列号和用户管理相关的内容，不能访问系统配置或财务系统。
4. 普通用户
权限：普通用户是最终的使用者，主要负责：
租赁服务：根据生成的序列号租赁服务，激活相应的服务器资源和 Docker 容器。
服务使用：使用相应的服务器资源、容器等，进行实际的服务消费。
无管理权限：普通用户没有管理权限，只能访问和使用自己的账户资源。
功能边界与实现
分销员作为管理员角色
分销员既是管理员的一种形式，主要负责与序列号管理、财务分成、用户注册及相关资源配置有关的操作。
分销员的核心功能是生成带有时间长度的序列号，并管理与这些序列号相关的用户及服务器资源。
分销员的权限控制是受超级管理员和普通管理员的制约的，不能直接访问系统的全局配置，也无法修改财务数据。
角色间权限关系
超级管理员拥有全权限，包括系统配置、权限分配、财务管理、分销系统管理等。
普通管理员拥有有限的权限，主要集中在用户管理与日常操作。
分销管理员主要负责序列号的生成与管理、分销收入控制等，与普通用户、管理员和超级管理员进行有效的权限区分。
普通用户只能租赁服务并使用序列号，无法管理任何系统资源。
后续开发与执行
数据库与 API 实现：需要根据角色的不同，设计不同的权限模型，并确保分销管理员的权限与普通管理员、超级管理员区分开来。
前端界面开发：在管理员界面中，分销管理员和普通管理员的功能应该清晰区分，管理员能够查看和管理自己权限下的用户、序列号和财务记录等。
测试与调试：通过详细的权限测试，确保每个角色的权限得以严格执行，避免越权操作。

#### 1.2 管理员帮助用户续费
- 管理员可手动续费并更新用户服务到期时间，系统自动发送续费通知。

#### 1.3 管理员注销用户
- 操作包括检查财务结算、销毁 ACL 文件、释放 Docker 容器资源、发送注销通知。

#### 1.4 查看用户账户行为
- 包括查看用户序列号使用情况、续费记录、登录信息等。

### **2. 用户注销功能**
#### 2.1 用户注销流程
- 包括销毁 ACL 文件、释放 Docker 容器资源、检查财务结算、发送注销通知。

#### 2.2 续费提醒与处理
- 系统根据到期时间发送续费通知，未续费用户将在 30 天后自动注销。

#### 2.3 邮件发送限制
- 每个用户邮箱每隔 10 分钟最多发送 5 封邮件，防止邮件滥用。

### **3. 系统日志与安全性**
#### 3.1 操作日志
- 记录管理员、用户的所有操作，包括时间、用户、操作类型和结果。

#### 3.2 权限控制
- 确保操作和数据访问严格遵守权限校验。

### **4. 服务器管理模块**
#### 4.1 服务器信息管理
- 记录服务器阿里云账号、IP 地址、用户数、流量消耗、剩余流量、速率检测和 Ping 延时检测。

#### 4.2 速率检测与 Ping 延时检测
- 提供实时的服务器速率与延时监控，确保服务质量。

### **5. ACL 管理模块**
#### 5.1 ACL 文件生成与下载
- 生成与下载 ACL 文件时需严格校验序列号的付费状态，并记录下载记录（用户名、IP 地址、机器校验码、浏览器信息等）。

#### 5.2 ACL 更新与日志
- ACL 文件 32 天后自动失效，管理员可手动更新 ACL，记录生成历史与日志。

#### 5.3 ACL 校验
- 确保每次下载 ACL 时校验序列号是否付费，防止非授权用户下载。

### **6. 序列号管理模块**
#### 6.1 序列号生成与过期
- 管理序列号的生命周期（生成、分配、过期），每个序列号 30 天后自动过期。

#### 6.2 序列号管理板块
- 包括序列号使用记录、状态查看、与服务器、Docker 容器的关联。

#### 6.3 序列号与分销系统的融合
- 分销员生成序列号并按分销等级获得收入，确保序列号与财务结算关联。

### **7. 续费与用户管理模块**
#### 7.1 续费功能
- 管理员可手动续费用户，系统会发送续费提醒（7 天、3 天、1 天前提醒）。

#### 7.2 用户注销功能
- 用户注销时，检查财务结算、销毁 ACL 文件和 Docker 容器资源。

### **8. 系统安全性与日志管理**
#### 8.1 操作日志
- 记录所有关键操作，确保系统操作可追溯。

#### 8.2 权限控制
- 对敏感操作（如用户注销、财务管理、ACL 文件下载）进行权限控制，确保操作安全。

### **9. 技术栈与架构设计**
- **前端**：React（UI 界面）
- **数据库**：MySQL
- **后端**：Flask 或 FastAPI（核心业务逻辑）
- **消息通知**：SMTP 邮件通知
- **异步任务**：Celery 和 Redis
- **监控与报警**：Prometheus 和 Grafana

### **10. 部署与实施步骤**
#### 10.1 开发阶段
- 开发用户注册、序列号激活、ACL 配置生成与更新等核心功能。

#### 10.2 初始部署
- 部署系统到云服务器并初始化数据库。

#### 10.3 生产部署
- 使用负载均衡和 Redis 缓存提升性能。

#### 10.4 监控与报警
- 部署 Prometheus 和 Grafana 监控系统。

---

### **数据库表设计**

根据系统需求，以下是数据库表结构的初步设计：

| 表名                 | 字段                                   | 类型             | 描述                                                     |
|----------------------|---------------------------------------|------------------|----------------------------------------------------------|
| `users`              | `id`                                 | Integer (PK)     | 用户 ID                                                  |
|                      | `username`                           | String (unique)  | 用户名                                                   |
|                      | `email`                              | String (unique)  | 邮箱地址                                                 |
|                      | `password`                           | String           | 密码                                                     |
|                      | `role`                               | String           | 用户角色（如 `user`, `admin`）                           |
|                      | `rental_expiry`                      | DateTime         | 租赁到期时间                                             |
|                      | `created_at`                         | DateTime         | 用户创建时间                                             |
| `serial_numbers`     | `id`                                 | Integer (PK)     | 序列号 ID                                                |
|                      | `code`                               | String (unique)  | 序列号代码                                               |
|                      | `duration_days`                      | Integer          | 有效天数                                                 |
|                      | `status`                             | String           | 序列号状态（`unused`, `used`, `expired`）                |
|                      | `user_id`                            | Integer (FK)     | 用户 ID（外键）                                          |
|                      | `created_at`                         | DateTime         | 序列号创建时间                                           |
|                      | `used_at`                            | DateTime         | 序列号使用时间                                           |
| `servers`            | `id`                                 | Integer (PK)     | 服务器 ID                                                |
|                      | `ip`                                 | String           | IP 地址                                                  |
|                      | `region`                             | String           | 服务器所在地区                                           |
|                      | `load`                               | Float            | 当前负载                                                 |
|                      | `status`                             | String           | 服务器状态（`healthy`, `unhealthy`）                     |
|                      | `created_at`                         | DateTime         | 创建时间                                                 |
|                      | `updated_at`                         | DateTime         | 更新时间                                                 |
| `acl_logs`           | `id`                                 | Integer (PK)     | 日志 ID                                                  |
|                      | `user_id`                            | Integer (FK)     | 用户 ID（外键）                                          |
|                      | `ip_address`                         | String           | 用户 IP 地址                                             |
|                      | `location`                           | String           | 地理位置                                                 |
|                      | `acl_version`                        | String           | ACL 版本号                                               |
|                      | `created_at`                         | DateTime         | 创建时间                                                 |
| `monitoring_logs`    | `id`                                 | Integer (PK)     | 日志 ID                                                  |
|                      | `server_id`                          | Integer (FK)     | 服务器 ID（外键）                                        |
|                      | `metric`                             | String           | 监控指标                                                 |
|                      | `value`                              | Float            | 监控值                                                   |
|                      | `timestamp`                          | DateTime         | 时间戳                                                   |
| `system_alerts`      | `id`                                 | Integer (PK)     | 告警 ID                                                  |
|                      | `alert_type`                         | String           | 告警类型                                                 |
|                      | `severity`                           | String           | 严重程度（`info`, `warning`, `critical`）                |
|                      | `message`                            | String           | 告警信息                                                 |
|                      | `resolved`                           | Boolean          | 是否已解决                                               |

---

### **API 接口设计**

以下是主要 API 的设计概要：

| 模块                  | 路由                                     | 方法   | 描述                                   | 请求参数                                   | 返回值示例                                      |
|-----------------------|------------------------------------------|--------|----------------------------------------|-------------------------------------------|-----------------------------------------------|
| 用户模块              | `/api/user/register`                    | POST   | 用户注册                               | `{ "username": "test", "email": "...", ...}` | `{ "success": true, "user_id": 1 }`           |
|                       | `/api/user/login`                       | POST   | 用户登录                               | `{ "email": "...", "password": "..." }`    | `{ "success": true, "token": "..." }`         |
| 序列号管理模块        | `/api/serial/generate`                  |

 POST   | 管理员生成序列号                       | `{ "duration_days": 30 }`                  | `{ "success": true, "serial_numbers": ["..."] }` |
| 服务器管理模块        | `/api/server/add`                       | POST   | 添加服务器                             | `{ "ip": "...", "region": "..." }`         | `{ "success": true, "server_id": 1 }`         |
| 容器管理模块          | `/api/container/allocate`               | POST   | 分配容器                               | `{ "user_id": 1, "server_id": 1, ... }`    | `{ "success": true, "container_id": 1 }`      |
| ACL 管理模块          | `/api/acl/generate`                     | POST   | 生成 ACL 配置                          | `{ "user_id": 1, "server_ids": [1, 2] }`   | `{ "success": true, "acl": { ... } }`         |
| 高可用模块            | `/api/ha/failover`                      | POST   | 故障切换                               | 无                                         | `{ "success": true, "message": "..." }`       |
| 日志管理模块          | `/api/logs/system`                      | GET    | 查询系统日志                           | 无                                         | `{ "success": true, "logs": [ ... ] }`        |
| 财务模块              | `/api/finance/statistics`               | GET    | 获取财务统计数据                       | 无                                         | `{ "success": true, "total_revenue": 1000 }`  |
| 监控模块              | `/api/monitoring/load_analysis`         | GET    | 分析服务器负载                         | 无                                         | `{ "success": true, "load_analysis": [...] }` |
| 通知模块              | `/api/notifications/send`               | POST   | 发送通知                               | `{ "user_id": 1, "subject": "...", ... }`  | `{ "success": true, "message": "Sent" }`      |

---

#
